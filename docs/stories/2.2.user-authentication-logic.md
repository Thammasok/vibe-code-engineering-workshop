# <!-- Powered by BMAD™ Core -->

# Story 2.2: User Authentication Logic

## Status
Draft

## Story
**As a** user,  
**I want** to be able to log in with my email and password,  
**so that** the system knows who I am and can grant me access.

## Acceptance Criteria
1. เมื่อกรอก Email/Password ถูกต้องและกด "เข้าสู่ระบบ" จะต้องพาผู้ใช้ไปยังหน้า Dashboard
2. เมื่อกรอก Email/Password ผิด จะต้องแสดงข้อความแจ้งเตือนที่ชัดเจน
3. (เบื้องต้น) ระบบสามารถรองรับการสร้างบัญชีผู้ใช้ใหม่ได้ (อาจจะเป็นฟังก์ชันหลังบ้านก่อนสำหรับ MVP)

## Tasks / Subtasks
- [ ] Task 1: Set up Supabase authentication (AC: 1, 2, 3)
  - [ ] Configure Supabase client with authentication enabled
  - [ ] Set up environment variables for Supabase URL and Anon Key
  - [ ] Create authentication service in apps/web/src/services/
  - [ ] Test Supabase connection and authentication setup
- [ ] Task 2: Implement authentication service methods (AC: 1, 2, 3)
  - [ ] Create signIn method with email/password
  - [ ] Create signUp method for user registration
  - [ ] Create getCurrentUser method for session checking
  - [ ] Create signOut method for logout functionality
  - [ ] Add proper error handling and TypeScript types
- [ ] Task 3: Integrate authentication with Login page (AC: 1, 2)
  - [ ] Connect LoginPage form submission to authentication service
  - [ ] Handle successful login with redirect to Dashboard
  - [ ] Display error messages for invalid credentials
  - [ ] Add loading states during authentication process
- [ ] Task 4: Set up authentication context/state management (AC: 1)
  - [ ] Create AuthContext using React Context API
  - [ ] Manage authentication state across the application
  - [ ] Store user session and user information
  - [ ] Provide authentication state to components
- [ ] Task 5: Handle authentication persistence (AC: 1)
  - [ ] Configure session persistence using Supabase
  - [ ] Handle browser refresh and session recovery
  - [ ] Manage token refresh automatically
  - [ ] Store minimal user data in context
- [ ] Task 6: Create user management utilities (AC: 3)
  - [ ] Create utility to check if user is authenticated
  - [ ] Add method to get current user profile
  - [ ] Implement basic user creation for MVP setup
  - [ ] Add error handling for common auth scenarios
- [ ] Task 7: Testing authentication flow (All ACs)
  - [ ] Create unit tests for authentication service
  - [ ] Test successful login flow and redirect
  - [ ] Test error handling for invalid credentials
  - [ ] Test session persistence and recovery

## Dev Notes

### Previous Story Insights
Story 2.1 (Login UI) provides the login form interface. This story adds the actual authentication logic that makes the login functional and connects to Supabase.

### Authentication Technology Requirements
[Source: architecture/tech-stack.md]
- **Backend**: Supabase Auth (built-in)
- **Authentication Method**: Email/Password
- **Session Management**: Automatic with Supabase
- **Token Management**: JWT tokens handled by Supabase client

### Data Models for Authentication
[Source: architecture/coding-standards.md + tech-stack.md]

```ts
// Authentication-related types for packages/shared/types.ts
export interface User {
  id: string;
  email: string;
  created_at: string;
  // Additional profile fields can be added later
}

export interface AuthState {
  user: User | null;
  session: Session | null;
  loading: boolean;
  error: string | null;
}

// Login form data
export interface LoginCredentials {
  email: string;
  password: string;
}
```

### Tech Stack Integration
[Source: architecture/tech-stack.md]
- **Frontend Language**: TypeScript ~5.x
- **Frontend Framework**: React ~18.x
- **State Management**: React Context API for authentication state
- **Backend**: Supabase Auth with PostgreSQL backend
- **Environment**: Variables via `import.meta.env.VITE_SUPABASE_*`

### Project Structure Requirements
[Source: architecture/unified-project-structure.md]
**Component Locations**:
- Auth service: `/apps/web/src/services/authService.ts`
- Auth context: `/apps/web/src/contexts/AuthContext.tsx`
- Auth types: `/packages/shared/types.ts`

### Supabase Configuration Requirements
[Source: architecture/coding-standards.md]
- **Environment Variables**: 
  - `VITE_SUPABASE_URL` - Supabase project URL
  - `VITE_SUPABASE_ANON_KEY` - Public anon key
- **Client Setup**: Use `@supabase/supabase-js` library
- **Configuration**: Initialize client in services layer

### Authentication Flow Design
1. **Login Flow**: LoginPage → AuthService → Supabase → Success → Dashboard redirect
2. **Error Flow**: Invalid credentials → Error message → Stay on LoginPage  
3. **Session Flow**: App startup → Check existing session → Dashboard or LoginPage
4. **Logout Flow**: User action → Clear session → Redirect to LoginPage

### State Management Strategy
[Source: architecture/tech-stack.md#State Management]
- Use React Context API for authentication state
- AuthContext provides user, session, loading, and error states
- Wrap main app with AuthProvider
- Components can access auth state via useAuth hook

### Environment Configuration Standards
[Source: architecture/coding-standards.md]
- **Environment Variables**: Access Supabase config via `import.meta.env.VITE_*`
- **Security**: Never expose private keys, only use public anon key
- **Configuration**: Centralized Supabase client initialization

### Error Handling Strategy
- **Network Errors**: Handle connection issues gracefully
- **Invalid Credentials**: Clear, user-friendly Thai error messages
- **Session Expiry**: Automatic redirect to login when session expires
- **Supabase Errors**: Map Supabase error codes to user messages

### Security Considerations
- **Password Security**: Never store passwords, let Supabase handle
- **Token Security**: Supabase handles JWT tokens automatically
- **Session Security**: Use Supabase's built-in security features
- **HTTPS**: Ensure all authentication happens over HTTPS

### MVP User Management
[Source: AC 3]
- Basic user registration capability for admin setup
- Users can be created via Supabase dashboard for MVP
- Focus on login functionality, registration UI can come later
- Prepare structure for user profile management

### Testing Requirements
[Source: architecture/tech-stack.md]
- **Testing Framework**: Vitest + React Testing Library
- **Auth Testing**: Mock Supabase client for unit tests
- **Flow Testing**: Test complete login/logout flows
- **Error Testing**: Test error handling scenarios

### File Locations
Based on project structure, create files at:
- Auth service: `/apps/web/src/services/authService.ts`
- Auth context: `/apps/web/src/contexts/AuthContext.tsx`
- Auth types: `/packages/shared/types.ts` (additions)
- Service tests: `/apps/web/src/services/authService.test.ts`
- Context tests: `/apps/web/src/contexts/AuthContext.test.tsx`

## Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 30/08/2025 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be populated by dev agent*

### Debug Log References  
*To be populated by dev agent*

### Completion Notes List
*To be populated by dev agent*

### File List
*To be populated by dev agent*

## QA Results
*Results from QA Agent review will be populated here*