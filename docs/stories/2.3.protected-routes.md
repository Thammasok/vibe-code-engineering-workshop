# <!-- Powered by BMAD™ Core -->

# Story 2.3: Protected Routes

## Status
Draft

## Story
**As a** system administrator,  
**I want** to ensure that only logged-in users can access the main application pages,  
**so that** our business data is secure.

## Acceptance Criteria
1. หากผู้ใช้ที่ยังไม่ได้ Login พยายามเข้าหน้า Dashboard, Customers, หรือ Jobs จะต้องถูก redirect ไปยังหน้า Login
2. ผู้ใช้ที่ Login แล้วเท่านั้นจึงจะสามารถเข้าถึงหน้าต่างๆ นอกจากหน้า Login ได้

## Tasks / Subtasks
- [ ] Task 1: Create ProtectedRoute component (AC: 1, 2)
  - [ ] Create `ProtectedRoute` wrapper component in apps/web/src/components/
  - [ ] Check authentication status from AuthContext
  - [ ] Redirect to /login if user not authenticated
  - [ ] Render protected content if user is authenticated
- [ ] Task 2: Implement route protection logic (AC: 1, 2)
  - [ ] Create route guard function to check auth status
  - [ ] Handle loading states during auth check
  - [ ] Add redirect with return URL for post-login navigation
  - [ ] Ensure smooth user experience during auth checks
- [ ] Task 3: Apply protection to main application routes (AC: 1)
  - [ ] Wrap Dashboard route with ProtectedRoute
  - [ ] Wrap Customers list and detail routes with ProtectedRoute
  - [ ] Wrap Jobs list and detail routes with ProtectedRoute
  - [ ] Ensure all business data pages are protected
- [ ] Task 4: Configure public vs protected route structure (AC: 2)
  - [ ] Create route structure with public routes (Login, forgot password)
  - [ ] Create route structure with protected routes (Dashboard, Customers, Jobs)
  - [ ] Implement fallback route handling for unauthenticated users
  - [ ] Add route-based navigation guards
- [ ] Task 5: Handle authentication state transitions (AC: 1, 2)
  - [ ] Handle user login → redirect to intended page or Dashboard
  - [ ] Handle user logout → redirect to Login page
  - [ ] Handle session expiry → automatic redirect to Login
  - [ ] Store and restore intended destination after login
- [ ] Task 6: Update navigation and linking (AC: 2)
  - [ ] Ensure sidebar navigation only shows for authenticated users
  - [ ] Update internal links to work with protected routing
  - [ ] Handle deep linking to protected pages
  - [ ] Add proper loading indicators during auth checks
- [ ] Task 7: Testing route protection (All ACs)
  - [ ] Test unauthenticated access redirects correctly
  - [ ] Test authenticated access works properly
  - [ ] Test session expiry and re-authentication
  - [ ] Test navigation between protected and public routes

## Dev Notes

### Previous Story Insights
Stories 2.1-2.2 establish login UI and authentication logic. This story secures the main application by ensuring only authenticated users can access business data.

### Authentication Integration
[Source: Story 2.2 context]
- Uses AuthContext from Story 2.2 for authentication state
- Depends on authService and session management
- Integrates with existing routing from Stories 1.3-1.5

### Route Security Requirements
[Source: prd/requirements.md]
- **Business Data Security**: Dashboard, Customers, Jobs must be protected
- **Public Access**: Login page must remain accessible
- **User Experience**: Seamless transitions between authenticated states

### Tech Stack Requirements
[Source: architecture/tech-stack.md]
- **Frontend Language**: TypeScript ~5.x
- **Frontend Framework**: React ~18.x
- **Routing**: React Router DOM (from Story 1.3)
- **State Management**: React Context API (AuthContext from Story 2.2)
- **Authentication**: Supabase Auth session management

### Project Structure Requirements
[Source: architecture/unified-project-structure.md]
**Component Locations**:
- Protected route: `/apps/web/src/components/ProtectedRoute.tsx`
- Route config: `/apps/web/src/App.tsx` (update existing)
- Auth utils: `/apps/web/src/utils/authUtils.ts` (if needed)

### Route Structure Design
```
Public Routes (accessible without auth):
- /login - Login page
- /forgot-password - Forgot password (future)

Protected Routes (require authentication):
- / - Dashboard (default route)
- /customers - Customer list
- /jobs - Job list  
- /jobs/:id - Job detail
```

### Protection Implementation Strategy
1. **ProtectedRoute Component**: HOC that wraps protected content
2. **Auth Check**: Use AuthContext to check authentication status
3. **Redirect Logic**: Redirect to /login with return URL parameter
4. **Loading State**: Handle auth loading states gracefully
5. **Session Management**: Integrate with Supabase session handling

### User Experience Flow
1. **Unauthenticated User**: Tries to access /dashboard → Redirected to /login
2. **Login Success**: Redirected to intended page or default Dashboard
3. **Authenticated User**: Can access all protected routes normally
4. **Session Expiry**: Automatically redirected to login with clear message

### Environment Configuration Standards
[Source: architecture/coding-standards.md]
- **Type Sharing**: Route protection types in `packages/shared/types.ts`
- **Component Patterns**: Follow established patterns from other components
- **Error Handling**: Consistent error handling across route protection

### Navigation Integration
- Sidebar navigation (Story 1.2) should only render for authenticated users
- Update Layout component to check auth status
- Protected routes should maintain layout and navigation
- Public routes (login) should use separate layout

### Security Considerations
- **Client-side Protection**: First line of defense, not security boundary
- **Token Validation**: Rely on Supabase's built-in token validation
- **Session Handling**: Automatic session refresh and expiry handling
- **Redirect Security**: Validate return URLs to prevent open redirect attacks

### Testing Requirements
[Source: architecture/tech-stack.md]
- **Testing Framework**: Vitest + React Testing Library
- **Route Testing**: Test protected route access and redirects
- **Auth Testing**: Mock AuthContext for different authentication states
- **Integration Testing**: Test complete user flows with routing

### Accessibility Requirements
[Source: prd/user-interface-design-goals.md#accessibility]
- **Loading States**: Accessible loading indicators during auth checks
- **Error Messages**: Clear, accessible error messages for auth failures
- **Navigation**: Keyboard accessible navigation in all auth states

### File Locations
Based on project structure, create files at:
- Protected route: `/apps/web/src/components/ProtectedRoute.tsx`
- Auth utilities: `/apps/web/src/utils/authUtils.ts`
- Component tests: `/apps/web/src/components/ProtectedRoute.test.tsx`
- Route types: `/packages/shared/types.ts` (if needed)

## Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 30/08/2025 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be populated by dev agent*

### Debug Log References  
*To be populated by dev agent*

### Completion Notes List
*To be populated by dev agent*

### File List
*To be populated by dev agent*

## QA Results
*Results from QA Agent review will be populated here*