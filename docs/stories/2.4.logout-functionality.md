# <!-- Powered by BMAD™ Core -->

# Story 2.4: Logout Functionality

## Status
Draft

## Story
**As a** user,  
**I want** a clear logout button,  
**so that** I can securely end my session.

## Acceptance Criteria
1. มีปุ่ม "ออกจากระบบ" แสดงอยู่ในตำแหน่งที่หาง่าย (เช่น ในแถบเมนูด้านซ้าย)
2. เมื่อกดปุ่ม "ออกจากระบบ" session ของผู้ใช้จะถูกเคลียร์ และระบบจะพากลับไปยังหน้า Login

## Tasks / Subtasks
- [ ] Task 1: Add logout button to sidebar navigation (AC: 1)
  - [ ] Update Sidebar component from Story 1.2 to include logout button
  - [ ] Position logout button at bottom of sidebar for easy access
  - [ ] Use shadcn/ui Button component with appropriate styling
  - [ ] Include logout icon (log-out from Lucide React)
- [ ] Task 2: Implement logout functionality (AC: 2)
  - [ ] Add logout method to AuthContext from Story 2.2
  - [ ] Call Supabase signOut method to clear session
  - [ ] Clear all authentication state and user data
  - [ ] Handle logout errors gracefully
- [ ] Task 3: Handle logout redirect and state cleanup (AC: 2)
  - [ ] Redirect user to /login page after successful logout
  - [ ] Clear any cached data or application state
  - [ ] Reset any form states or temporary data
  - [ ] Ensure clean transition to unauthenticated state
- [ ] Task 4: Add logout confirmation (optional UX improvement)
  - [ ] Add confirmation dialog before logging out (optional)
  - [ ] Use shadcn/ui AlertDialog component if implemented
  - [ ] Provide clear feedback during logout process
  - [ ] Handle logout loading state
- [ ] Task 5: Update authentication context for logout (AC: 2)
  - [ ] Extend AuthContext to include logout function
  - [ ] Update auth state management to handle logout
  - [ ] Ensure logout is accessible from any authenticated page
  - [ ] Add proper TypeScript types for logout functionality
- [ ] Task 6: Handle edge cases and error scenarios (AC: 2)
  - [ ] Handle network errors during logout
  - [ ] Handle cases where session is already expired
  - [ ] Provide fallback logout (clear local state even if server call fails)
  - [ ] Add proper error messages for logout failures
- [ ] Task 7: Testing logout functionality (All ACs)
  - [ ] Create unit tests for logout button and functionality
  - [ ] Test successful logout flow and redirect
  - [ ] Test logout error handling scenarios
  - [ ] Test logout from different pages in the application

## Dev Notes

### Previous Story Insights
Stories 2.1-2.3 establish complete authentication system. This final story completes the auth flow by allowing users to securely exit the system and return to login state.

### Authentication Integration
[Source: Stories 2.2, 2.3 context]
- Uses AuthContext and authService from Story 2.2
- Integrates with protected routing from Story 2.3  
- Updates Sidebar component from Story 1.2

### User Experience Requirements
[Source: prd/user-interface-design-goals.md]
- **"Effortless" Philosophy**: Logout should be obvious and simple
- **Clear Visual Cues**: Button should be easily identifiable
- **Consistent Design**: Follow existing sidebar design patterns
- **Immediate Feedback**: Clear indication that logout is happening

### Tech Stack Requirements
[Source: architecture/tech-stack.md]
- **Frontend Language**: TypeScript ~5.x
- **Frontend Framework**: React ~18.x
- **UI Components**: shadcn/ui Button, AlertDialog (optional)
- **Icons**: Lucide React log-out icon
- **Authentication**: Supabase Auth signOut method

### Project Structure Requirements
[Source: architecture/unified-project-structure.md]
**Component Updates**:
- Update existing: `/apps/web/src/components/Sidebar.tsx`
- Update existing: `/apps/web/src/contexts/AuthContext.tsx`
- Update existing: `/apps/web/src/services/authService.ts`

### Sidebar Integration Design
[Source: Story 1.2 context]
- Add logout button to existing Sidebar component
- Position at bottom of menu for logical separation
- Maintain consistent styling with other menu items
- Use appropriate icon and Thai text label

### Logout Flow Implementation
1. **User Action**: Click "ออกจากระบบ" button in sidebar
2. **Confirmation**: Optional confirmation dialog (good UX practice)
3. **Service Call**: Call authService.signOut() → Supabase signOut
4. **State Cleanup**: Clear AuthContext state and user data
5. **Redirect**: Navigate to /login page
6. **Feedback**: Show success message or handle errors

### Authentication State Management
[Source: Story 2.2 context]
- Extend AuthContext with logout function
- Clear user, session, and any cached data
- Reset authentication state to initial/unauthenticated
- Ensure state cleanup prevents memory leaks

### Error Handling Strategy
- **Network Errors**: Handle offline/connectivity issues during logout
- **Session Errors**: Handle already expired sessions gracefully
- **Fallback Logout**: Clear local state even if server call fails
- **User Feedback**: Clear error messages in Thai language

### Security Considerations
- **Complete Session Cleanup**: Ensure all tokens and session data cleared
- **Supabase Integration**: Use Supabase's built-in secure signOut method
- **State Security**: Clear any sensitive data from application state
- **Redirect Security**: Ensure redirect to login page is secure

### Testing Requirements
[Source: architecture/tech-stack.md]
- **Testing Framework**: Vitest + React Testing Library
- **Component Testing**: Test logout button rendering and interactions
- **Integration Testing**: Test complete logout flow with AuthContext
- **Error Testing**: Test logout error scenarios and fallbacks

### Accessibility Requirements
[Source: prd/user-interface-design-goals.md#accessibility]
- **Button Accessibility**: Proper labels, keyboard navigation
- **Screen Reader**: Clear semantic markup for logout action
- **Focus Management**: Proper focus handling during logout process
- **Confirmation Dialog**: Accessible dialog if implemented

### UI Design Specifications
- **Button Position**: Bottom of sidebar, visually separated from main menu
- **Icon**: Log-out icon from Lucide React
- **Text**: "ออกจากระบบ" in Thai
- **Styling**: Consistent with sidebar theme, slightly different to indicate action
- **States**: Normal, hover, loading states

### File Locations
Based on project structure, update existing files at:
- Sidebar: `/apps/web/src/components/Sidebar.tsx` (update)
- Auth context: `/apps/web/src/contexts/AuthContext.tsx` (update)
- Auth service: `/apps/web/src/services/authService.ts` (update)
- Tests: Adjacent `.test.tsx` files for updated components

## Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 30/08/2025 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be populated by dev agent*

### Debug Log References  
*To be populated by dev agent*

### Completion Notes List
*To be populated by dev agent*

### File List
*To be populated by dev agent*

## QA Results
*Results from QA Agent review will be populated here*